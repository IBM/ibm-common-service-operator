apiVersion: spp-data-protection.isf.ibm.com/v1alpha1
kind: Recipe
metadata:
  name: child-license-reporter-recipe
  namespace: <lsr namespace>
  labels:
    dp.isf.ibm.com/parent-recipe: cpfs-singleton-parent-recipe
    dp.isf.ibm.com/parent-recipe-namespace: <fusion ns>
spec:
  appType: common-service
  groups:
    # lsr chart resources
    - includeClusterResources: true
      includedResourceTypes:
        - customresourcedefinitions.apiextensions.k8s.io
        - secrets
        - ibmlicenseservicereporters.operator.ibm.com
        - serviceaccount
        - role
        - rolebinding
        - deployments
        - clusterrole
        - clusterrolebinding
      labelSelector: foundationservices.cloudpak.ibm.com=lsr-chart
      name: license-service-reporter-parent-resources
      type: resource
    - backupRef: license-service-reporter-parent-resources
      includeClusterResources: true
      includedResourceTypes:
        - customresourcedefinitions.apiextensions.k8s.io
      name: license-service-reporter-crd
      type: resource
    - backupRef: license-service-reporter-parent-resources
      includeClusterResources: true
      includedResourceTypes:
        - serviceaccount
        - clusterrole
        - clusterrolebinding
        - role
        - rolebinding
      name: license-service-reporter-rbac-resources
      type: resource
    - backupRef: license-service-reporter-parent-resources
      includeClusterResources: true
      includedResourceTypes:
        - ibmlicenseservicereporters.operator.ibm.com
        - secrets
      name: license-service-reporter-workload-resources
      type: resource
    - backupRef: license-service-reporter-parent-resources
      includeClusterResources: true
      includedResourceTypes:
        - deployments
      name: license-service-reporter-deployment
      type: resource
    # lsr data resources
    - includeClusterResources: true
      includedResourceTypes:
        - serviceaccount
        - role
        - rolebinding
        - configmaps
      name: lsr-pre-deploy
      type: resource
      labelSelector: foundationservices.cloudpak.ibm.com=lsr-data
    - includeClusterResources: true
      includedResourceTypes:
        - deployments
      name: lsr-deployment
      labelSelector: foundationservices.cloudpak.ibm.com=lsr-data
      type: resource
    - labelSelector: foundationservices.cloudpak.ibm.com=lsr-data
      name: lsr-volume
      type: volume
  hooks:
    - chks:
        - condition: '{$.status.phase} == {"Running"}'
          name: podReady
          onError: fail
          timeout: 600
      name: lsr-operator-check
      labelSelector: app.kubernetes.io/name=ibm-license-service-reporter
      namespace: <lsr namespace>
      onError: fail
      selectResource: pod
      timeout: 600
      type: check
    - chks:
        - condition: '{$.status.phase} == {"Running"}'
          name: podReady
          onError: fail
          timeout: 600
      name: lsr-instance-check
      labelSelector: app.kubernetes.io/name=ibm-license-service-reporter-instance
      namespace: <lsr namespace>
      onError: fail
      selectResource: pod
      timeout: 600
      type: check
    - chks:
        - condition: '{$.spec.replicas} == {$.status.readyReplicas}'
          name: podReady
          onError: fail
          timeout: 600
      labelSelector: foundationservices.cloudpak.ibm.com=lsr-data
      name: lsr-deployment
      namespace: <lsr namespace>
      onError: fail
      selectResource: deployment
      timeout: 600
      type: check
    - labelSelector: foundationservices.cloudpak.ibm.com=lsr-data
      name: lsr-data
      namespace: <lsr namespace>
      onError: fail
      ops:
        - command: |
            ["/bin/bash", "-c", "rm -rf /lsr/lsr-backup/database; /lsr/br_lsr.sh <lsr namespace> backup"]
          container: lsr-backup-job
          name: backup
          timeout: 600
        - command: |
            ["/bin/bash", "-c", "/lsr/br_lsr.sh <lsr namespace> restore"]
          container: lsr-backup-job
          name: restore
          timeout: 2000
      selectResource: pod
      type: exec
  workflows:
    - failOn: any-error
      name: singleton-resources-backup
      sequence:
        - hook: lsr-data/backup
        - group: license-service-reporter-parent
        - group: lsr-pre-deploy
        - group: lsr-volume
        - group: lsr-deployment
    - failOn: any-error
      name: singleton-resources-restore
      sequence:
        - group: license-service-reporter-crd
        - group: license-service-reporter-rbac-resources
        - group: license-service-reporter-workload-resources
        - group: license-service-reporter-deployment
        - hook: lsr-operator-check/podReady
        - group: lsr-pre-deploy
        - group: lsr-volume
        - group: lsr-deployment
        - hook: lsr-deployment/podReady
        - hook: lsr-instance-check/podReady
        - hook: lsr-data/restore